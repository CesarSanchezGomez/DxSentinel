// frontend/static/js/result.js
(function() {
    'use strict';

    const resultContainer = document.getElementById('resultContainer');

    // Utility: Manejo de errores de autenticación
    function handleAuthError(response) {
        if (response.status === 401 || response.status === 403) {
            window.location.href = '/auth/login';
            return true;
        }
        return false;
    }

    // Formatear tamaño de archivo
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Formatear fecha
    function formatDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('es-MX', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Cargar lista de archivos procesados
    async function loadProcessedFiles() {
        try {
            resultContainer.innerHTML = '<p>Cargando archivos procesados...</p>';

            const response = await fetch('/api/v1/process/list', {
                credentials: 'include'
            });

            if (handleAuthError(response)) {
                return;
            }

            if (!response.ok) {
                throw new Error('Error al cargar archivos');
            }

            const data = await response.json();

            if (!data.success || data.count === 0) {
                resultContainer.innerHTML = `
                    <p>No hay archivos procesados aún.</p>
                    <a href="/upload">Subir y procesar archivos</a>
                `;
                return;
            }

            // Crear tabla con los archivos
            let html = `
                <h2>Archivos Procesados (${data.count})</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Archivo</th>
                            <th>Tamaño</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.files.forEach(file => {
                html += `
                    <tr>
                        <td>${file.filename}</td>
                        <td>${formatFileSize(file.size)}</td>
                        <td>${formatDate(file.created)}</td>
                        <td>
                            <a href="${file.download_url}" download>Descargar</a>
                            <button onclick="deleteFile('${file.filename}')" class="delete-btn">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            resultContainer.innerHTML = html;

        } catch (error) {
            console.error('Error:', error);
            resultContainer.innerHTML = `
                <p style="color: red;">Error al cargar archivos: ${error.message}</p>
            `;
        }
    }

    // Eliminar archivo
    async function deleteFile(filename) {
        if (!confirm(`¿Estás seguro de eliminar ${filename}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/v1/process/output/${filename}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (handleAuthError(response)) {
                return;
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al eliminar archivo');
            }

            // Recargar lista
            await loadProcessedFiles();

        } catch (error) {
            console.error('Error:', error);
            alert(`Error al eliminar archivo: ${error.message}`);
        }
    }

    // Exponer función para los botones
    window.deleteFile = deleteFile;

    // Cargar archivos al inicio
    loadProcessedFiles();
})();